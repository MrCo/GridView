(function(win){var _GridView=function(opts){this.settings=$.extend({container:$("body"),id:"gridView"+parseInt(100000000*Math.random()),className:"gridView",columnHighClassName:"highBack",dataKeyID:"id",columnFilling:true,selectedColumn:true,columnNo:true,dataSource:[{id:"001",name:"张三",age:"32",sex:"男",address:"北京市",income:"100W"},{id:"002",name:"王老五",age:"23",sex:"男",address:"重庆市",income:"100W"}],columns:[{name:"编号",field:"id",order:0,width:40,titleAlign:"center",contentAlign:"center",display:"none",link:"/main.html?key={id}"},{name:"年龄",field:"age",order:2,width:60,titleAlign:"center",contentAlign:"center",link:"/main.html?key={id}",clickCallback:function(){var _$this=$(this);return false},formatCallback:function($this){return $this.text().length>0?"2014年01月12日":""}},{name:"性别",field:"sex",order:4,width:120,titleAlign:"center",contentAlign:"center",clickCallback:function(){var _$this=$(this)}},{name:"地址",field:"address",order:3,width:160,titleAlign:"center",contentAlign:"center",formatCallback:function($this){return $this.text().length>0?"中国重庆市江津区":""},clickCallback:function(){var _$this=$(this)}},{name:"姓名",field:"name",order:1,width:120,titleAlign:"center",contentAlign:"center"},{name:"收入",field:"income",order:5,width:180,titleAlign:"center",contentAlign:"center"},{name:"编辑",order:6,width:120,titleAlign:"center",contentAlign:"center"}],editColumn:[{name:"删除",type:"delete",action:"/main.ashx?key={id}",after:"<span>|</span>",visible:true,append:'<img src="/skin/images/btn_save.gif" />'},{name:"通过",type:"common",action:"/main.ashx?key={id}",after:"<span>|</span>",clickCallback:function(actionType,actionURL){var _$this=this;alert(_$this.attr("action"))}},{name:"更新",type:"update",action:"/main.ashx",columns:[{rowIndex:1,type:"hidden",name:""},{rowIndex:2,type:"text",name:""},{rowIndex:3,type:"text",name:""},{rowIndex:4,type:"select",name:"",action:"/main.ashx",dataSource:[{id:"010",name:"北京市"},{id:"023",name:"重庆市"}],dataKeyID:"id",dataKeyText:"name"},{rowIndex:6,type:"checkbox",name:"",action:"/main.ashx",dataSource:[{id:"010",name:"5W"},{id:"010",name:"10W"},{id:"010",name:"20W"},{id:"010",name:"30W"}],dataKeyID:"id",dataKeyText:"name"},{rowIndex:5,type:"radio",name:"",action:"/main.ashx",dataSource:[{id:"1",name:"男"},{id:"2",name:"女"}],dataKeyID:"id",dataKeyText:"name"}],after:"<span>|</span>",append:'<img src="/skin/images/xg.gif" width="48" height="22" />',saveAppend:'<img src="/skin/images/btn_save.gif" width="48" height="22" />'},{name:"详情",type:"common",action:"/detial.html?key={id}&name={name}",visible:function(data){return false},formatCallback:function(data){if(data.id=="001"){return"批准"}else{return"退回"}},clickCallback:function(actionType,actionURL){var _$this=this;alert(_$this.text())}}],editUpdateCallback:function(datakey,editData,dataSource){console.log(dataSource)},columnClickHandle:function(){var _$this=$(this)},columnDBClickHandle:function(e){var _$this=$(this)},checkboxChangeHandle:function(data){var _checked=data.checked,_value=data.value}},opts);var _gridHTML='<table id="'+this.settings.id+'" class="'+this.settings.className+'">    <thead></thead>    <tbody></tbody>    <tfoot></tfoot></table>';this.settings.container.html(_gridHTML)};_GridView.prototype.BindDataSource=function(){var _this=this,_$grid=$("#"+_this.settings.id),_source=_this.settings.dataSource,_columns=_this.settings.columns,_theadList="",_tbodyList="";_columns.sort(function(a,b){if(a.order<b.order){return -1}else{if(a.order==b.order){return 0}else{return 1}}});_theadList="<tr>";for(var i=0,_count=_columns.length;i<_count;i++){var _column=_columns[i],_thAttrs="";if(!_column){continue}if(_column.width){_thAttrs+=" width:"+_column.width+"px;"}if(_column.titleAlign){_thAttrs+=" text-align:"+_column.titleAlign+";"}if(_column.display){_thAttrs+="display:"+_column.display+";"}_theadList+='<th style="'+_thAttrs+'">'+_column.name+"</th>"}_theadList+="</tr>";_$grid.children("thead").html(_theadList);for(var j=0,_count2=!!_this.settings.columnFilling&&_this.settings.pages?_this.settings.pages.size:_source.length;j<_count2;j++){var _data=_source[j],_trClass=_this.settings.columnHighClassName&&(j+1)%2==0?' class="'+_this.settings.columnHighClassName+'"':"";_tbodyList+='<tr idx="'+(_data?_data[_this.settings.dataKeyID]:"")+'" '+_trClass+">";for(i=0,_count=_columns.length;i<_count;i++){_column=_columns[i];if(!_column){continue}if(_column.contentAlign){_thAttrs="text-align:"+_column.contentAlign+";"}if(_column.display){_thAttrs+="display:"+_column.display+";"}if(_column.field){_tbodyList+='<td idx="'+i+'" style="'+_thAttrs+'">';if(!_data){_tbodyList+="</td>"}else{if(_column.link){_tbodyList+='<a href="'+_this.ReplaceData(_column.link,_data)+'" target="_blank">'+_data[_column.field]+"</a></td>"}else{_tbodyList+=_data[_column.field]+"</td>"}}}else{_tbodyList+='<td style="'+_thAttrs+'"></td>'}}_tbodyList+="</tr>"}_$grid.children("tbody").html(_tbodyList);_$grid.children("tbody").find("td").each(function(i){var _$this=$(this),_index=_$this.attr("idx"),_column=_columns[_index];if(_column&&typeof _column.clickCallback=="function"){_$this.bind("click",function(e){_column.clickCallback.call(this);if(e.stopPropagation){e.stopPropagation()}else{e.cancelBubble=true}e.preventDefault()})}if(_column&&typeof _column.formatCallback=="function"){if(_column.link){_$this.find("a").html(_column.formatCallback(_$this))}else{_$this.html(_column.formatCallback(_$this))}}});_this.RemoveLoading();return _this};_GridView.prototype.Loading=function(){var _this=this,_$grid=$("#"+_this.settings.id),_$gridContainer=_$grid.parent(),_headHeight=_$grid.children("thead").height(),_loadingHtml='<div id="girdviewLoading" style="position:absolute; background:#fff; text-align:center; filter:alpha(opacity=60); opacity:0.6; width:'+_$grid.width()+"px; height:"+(_$grid.height()-_headHeight)+"px; top:"+_headHeight+'px; left:0px;"><img title="数据加载中..." src="/SCRIPTS/pagekage/utils/widget/gridview/loading.gif" style="position:absolute; width:15px; height:15px; left:50%; top:50%; margin-left:-7.5px; margin-top:-'+(_headHeight+7.5)+'px; " /></div>';_$gridContainer.attr("style","position:relative;").append(_loadingHtml)};_GridView.prototype.RemoveLoading=function(){$("#girdviewLoading").remove();return this};_GridView.prototype.ResetBindData=function(data){this.settings.dataSource=data;this.BindDataSource().BindColumnNo().SelectedColumn().AddEditColumn().BindColumnClickListener().BindCheckboxChangeListener()};_GridView.prototype.SelectedColumn=function(){var _this=this,_$grid=$("#"+_this.settings.id),_source=_this.settings.dataSource,_eisabled=_this.settings.selectedColumn,_chkAllID=_this.settings.id+"_ChkAll";if(_eisabled!==true){return _this}_$grid.children("thead").children("tr").prepend('<th style="width:20px;"><input id="'+_chkAllID+'" type="checkbox"/></th>');_$grid.children("tbody").children("tr").prepend("<td></td>");for(var j=0,_sourceCount=_source.length;j<_sourceCount;j++){_$grid.children("tbody").children("tr").eq(j).children("td:first").attr("style","text-align:center;").html('<input type="checkbox"/>')}$("#"+_chkAllID).change(function(){var _$chkbox=_$grid.children("tbody").children("tr").children("td").children("input[type=checkbox]"),_chkStatus=$(this).attr("checked");_$chkbox.attr("checked",_chkStatus?true:false)});return _this};_GridView.prototype.BindColumnNo=function(){var _this=this,_$grid=$("#"+_this.settings.id),_source=_this.settings.dataSource;if(!_this.settings.columnNo||!!!_this.settings.columnNo){return _this}_$grid.children("thead").children("tr").prepend('<th style="width:30px;">序号</th>');_$grid.children("tbody").children("tr").prepend('<td style="text-align:center;"></td>');for(var j=0,_sourceCount=_source.length;j<_sourceCount;j++){_$grid.children("tbody").children("tr").eq(j).children("td:first").html(j+1)}return _this};_GridView.prototype.ReplaceData=function(str,data){return str.replace(/(\{(.*?)\})/g,function(a,b,c){return data[c]})};_GridView.prototype.EditRow=function(index,keyID){var _this=this,_editColumn=_this.settings.editColumn,_$grid=$("#"+_this.settings.id),_$row=_$grid.children("tbody").children("tr").eq(index),_updateColumn;for(var i=0,_count=_editColumn.length;i<_count;i++){_updateColumn=_editColumn[i];if(_updateColumn.type=="update"){break}}if(!_updateColumn.columns){alert("温馨提示：您未设置columns属性");return}for(i=0,_count=_updateColumn.columns.length;i<_count;i++){var _columnData=_updateColumn.columns[i],_column=_$row.children("td").eq(_columnData.rowIndex),_tempVal=_column.text(),_tempHtml="",_tempData;switch(_columnData.type){case"hidden":_column.append('<input type="hidden" name="'+_columnData.name+'" value="'+_tempVal+'" />');break;case"text":_column.html('<input type="text" name="'+_columnData.name+'" value="'+_tempVal+'" />');break;case"select":_column.html('<select name="'+_columnData.name+'"><option>加载中...</option></select>');var _$select=_column.children("select");if(_columnData.dataSource){for(var j=0,_length=_columnData.dataSource.length;j<_length;j++){_tempData=_columnData.dataSource[j];_tempHtml+='<option value="'+_tempData[_columnData.dataKeyID]+'">'+_tempData[_columnData.dataKeyText]+"</option>"}_$select.html(_tempHtml)}else{$.post(_column.action,{key:keyID},function(result){for(var j=0,_length=result.length;j<_length;j++){_tempData=result[j];_tempHtml+='<option value="'+_tempData[_columnData.dataKeyID]+'">'+_tempData[_columnData.dataKeyText]+"</option>"}_$select.html(_tempHtml)})}break;case"checkbox":_column.html("加载中...");if(_columnData.dataSource){for(var j=0,_length=_columnData.dataSource.length;j<_length;j++){_tempData=_columnData.dataSource[j];_tempHtml+='<label><input type="checkbox" name-data="'+_columnData.name+'" name="'+_columnData.name+"_"+index+'" value="'+_tempData[_columnData.dataKeyID]+'" />'+_tempData[_columnData.dataKeyText]+"</label>"}_column.html(_tempHtml)}else{$.post(_column.action,{key:keyID},function(result){for(var j=0,_length=result.length;j<_length;j++){_tempData=result[j];_tempHtml+='<label><input type="checkbox" value="'+_tempData[_columnData.dataKeyID]+'" />'+_tempData[_columnData.dataKeyText]+"</label>"}_column.html(_tempHtml)})}break;case"radio":_column.html("加载中...");if(_columnData.dataSource){for(var j=0,_length=_columnData.dataSource.length;j<_length;j++){_tempData=_columnData.dataSource[j];_tempHtml+='<label><input type="radio" name-data="'+_columnData.name+'" name="'+_columnData.name+"_"+index+'" value="'+_tempData[_columnData.dataKeyID]+'" />'+_tempData[_columnData.dataKeyText]+"</label>"}_column.html(_tempHtml)}else{$.post(_column.action,{key:keyID},function(result){for(var j=0,_length=result.length;j<_length;j++){_tempData=result[j];_tempHtml+='<label><input type="radio" value="'+_tempData[_columnData.dataKeyID]+'" />'+_tempData[_columnData.dataKeyText]+"</label>"}_column.html(_tempHtml)})}break;default:return}}};_GridView.prototype.GetEditColumnValue=function(editRow){var _values={};editRow.children("td").each(function(){var _$this=$(this),_$hide=_$this.children("input[type=hidden]"),_$txt=_$this.children("input[type=text]"),_$select=_$this.children("select"),_$chkbox=_$this.find("input[type=checkbox]"),_$radio=_$this.find("input[type=radio]"),_tempValue="",_tempText="";if(_$hide.size()>0){_values[_$hide.attr("name")]=_$hide.val();_$this.children("input[type=hidden]").remove()}if(_$txt.size()>0){_values[_$txt.attr("name")]=_$txt.val();_$this.html(_$txt.val())}if(_$select.size()>0){_values[_$select.attr("name")]=_$select.val();_$this.html(_$select.children("option").eq(_$select[0].selectedIndex).text())}if(_$chkbox.size()>0&&!_$chkbox.attr("select")){_$chkbox.each(function(){if($(this).attr("checked")){_tempValue+=$(this).val()+",";_tempText+=$(this).parent().text()+","}});_values[_$chkbox.eq(0).attr("name-data")]=_tempValue.substring(0,_tempValue.length-1);_$this.html(_tempText.substring(0,_tempText.length-1))}if(_$radio.size()>0){_$radio.each(function(){if($(this).attr("checked")){_tempValue+=$(this).val();_tempText+=$(this).parent().text()}});_values[_$radio.eq(0).attr("name-data")]=_tempValue;_$this.html(_tempText)}});return _values};_GridView.prototype.AddEditColumn=function(){var _this=this,_$grid=$("#"+_this.settings.id),_editColumn=_this.settings.editColumn,_source=_this.settings.dataSource,_actionHTML="";if(!_editColumn||_editColumn.length<1){return _this}for(var j=0,_sourceCount=_source.length;j<_sourceCount;j++){var _sourceData=_source[j];for(var i=0,_count=_editColumn.length;i<_count;i++){var _data=_editColumn[i],_visible,_editName="";if(!_data){continue}if(typeof _data.formatCallback=="function"){_editName=_data.formatCallback(_sourceData)}if(typeof _data.visible=="function"){_visible=_data.visible(_sourceData)}if(!!!_data.visible||!!!_visible){if(_data.append&&_data.append!=""){var _saveAppend=_data.saveAppend?' saveAppend="'+_data.saveAppend.replace(/"/g,"'")+'"':"";_actionHTML+='<span><a idx="'+i+'" type="'+_this.ReplaceData(_data.type,_sourceData)+'" action="'+_this.ReplaceData(_data.action,_sourceData)+'" '+_saveAppend+">"+_data.append+"</a></span>"}else{_actionHTML+='<span><a idx="'+i+'" type="'+_this.ReplaceData(_data.type,_sourceData)+'" action="'+_this.ReplaceData(_data.action,_sourceData)+'">'+(_editName!=""?_editName:_this.ReplaceData(_data.name,_sourceData))+"</a></span>"}}if(_data.after){_actionHTML+=_data.after}}_$grid.children("tbody").children("tr").eq(j).children("td:last").html(_actionHTML);_actionHTML=""}_$grid.children("tbody").find('a[type!=""]').bind("click",function(){var _$this=$(this),_actionType=_$this.attr("type"),_actionURL=_$this.attr("action"),_editIndex=_$this.attr("idx"),_thisRow=_$this.parent().parent().parent(),_keyID=_thisRow.attr("idx"),_saveAppend=_$this.attr("saveappend")||"",_index=_thisRow.index();var _clickCallback=_editColumn&&_editColumn[_editIndex]?_editColumn[_editIndex].clickCallback:undefined;if(typeof _clickCallback=="function"){_clickCallback.call(_$this,_actionType,_actionURL);return}switch(_actionType&&_actionType.toLowerCase()){case"delete":if(!confirm("温馨提示：您确定要删除吗？")){return}$.ajax({type:"get",url:_actionURL,async:false,cache:false,success:function(result){result=eval("("+result+")");if(result.status=="200"){alert("温馨提示：删除成功!");location=location}else{alert("温馨提示：删除失败,请稍后再试！")}}});break;case"common":$.ajax({type:"get",url:_actionURL,async:false,cache:false,success:function(result){result=eval("("+result+")");if(result.status=="200"){alert("温馨提示：操作成功!");location=location}else{alert("温馨提示：操作失败,请稍后再试！")}}});break;case"update":var _actionStatus=_$this.attr("action_status");if(_actionStatus&&_actionStatus=="edit"){if(!confirm("温馨提示：您确定要保存吗？")){return}var _resultData=_this.GetEditColumnValue(_thisRow);if(typeof _this.settings.editUpdateCallback=="function"){_this.settings.editUpdateCallback(_keyID,_resultData,_source[_index])}_$this.removeAttr("action_status");if(_saveAppend!=""){_$this.html(_$this.attr("old_name"))}else{_$this.text(_$this.attr("old_name"))}}else{_this.EditRow(_index,_keyID);if(_saveAppend!=""){_$this.attr("old_name",_$this.html()).html(_saveAppend).attr("action_status","edit")}else{_$this.attr("old_name",_$this.text()).text("保存").attr("action_status","edit")}}break;case"link":window.open(_actionURL);break;default:return}});return _this};_GridView.prototype.DataPager=function(){var _this=this,_$grid=$("#"+_this.settings.id),_pages=_this.settings.pages,_pageCount=1,_pageHtml='<a action="home">首页</a><a action="prev">上一页</a><a action="next">下一页</a><a action="last">尾页</a><span><label>跳转至</label><select>@</select>页</span>',_colspan=!!_this.settings.selectedColumn&&!!_this.settings.columnNo?_this.settings.columns.length+2:!!_this.settings.selectedColumn||!!_this.settings.columnNo?_this.settings.columns.length+1:_this.settings.columns.length,_tempHtml="";if(!_pages){return _this}_pageCount=parseInt(_pages.count%_pages.size==0?_pages.count/_pages.size:_pages.count>_pages.size?_pages.count/_pages.size+1:1);for(var i=1;i<=_pageCount;i++){_tempHtml+='<option value="'+i+'">'+i+"</option>"}_pageHtml=_pageHtml.replace(/@/g,_tempHtml);if(_this.settings.pages.display=="none"){return _this}_$grid.children("tfoot").html('<tr><td colspan="'+_colspan+'">'+_pageHtml+"</td></tr>");_$grid.children("tfoot").find("td").bind("click",function(e){if(e.target.nodeName.toLowerCase()=="a"){var _action=$(e.target).attr("action");switch(_action){case"home":_pages.index=1;break;case"prev":if(_pages.index==1){alert("温馨提示：已经是第一页了!");return}_pages.index--;break;case"next":if(_pages.index==_pageCount){alert("温馨提示：已经是最后一页了！");return}_pages.index++;break;case"last":_pages.index=_pageCount;break;default:return}var _$select=$(this).find("select");_$select.children("option").eq(_pages.index-1).attr("selected","selected");_this.Loading();_pages.pageClickEvent(_pages.index,_this)}}).find("select").bind("change",function(){_pages.index=parseInt($(this).children("option").eq($(this)[0].selectedIndex).text());_this.Loading();_pages.pageClickEvent(_pages.index,_this)});return _this};_GridView.prototype.BindColumnClickListener=function(){var _this=this,_$grid=$("#"+_this.settings.id),_$trList=_$grid.children("tbody").children("tr"),_clickCount=0,_clickEvent={};if(typeof _this.settings.columnClickHandle=="function"){_$trList.bind("click",function(){var _$this=this;_clickCount++;_clickEvent["click"+_clickCount]=setTimeout(function(){_this.settings.columnClickHandle.call(_$this)},200)})}if(typeof _this.settings.columnDBClickHandle=="function"){_$trList.bind("dblclick",function(){for(var e in _clickEvent){clearTimeout(_clickEvent[e])}_clickEvent={};_this.settings.columnDBClickHandle.call(this)})}return _this};_GridView.prototype.GetSelectedValue=function(){var _this=this,_$grid=$("#"+_this.settings.id),_$trList=_$grid.children("tbody").children("tr"),_result=[],_chkStatus=$(this).attr("checked");if(!_this.settings.selectedColumn){return _result}_$trList.each(function(){var _$this=$(this),_$checkbox=_$this.children("td").eq(0).children("input[type=checkbox]");if(_$checkbox[0].checked){_result.push(_$checkbox.parent().parent().attr("idx"))}});return _result};_GridView.prototype.SelectedCheckBox=function(columnIndex){var _this=this,_$grid=$("#"+_this.settings.id);if(!_this.settings.selectedColumn||!!!_this.settings.selectedColumn){return}var _$checkbox=_$grid.children("tbody").children("tr").eq(columnIndex).children("td").eq(0).children("input[type=checkbox]");if(_$checkbox){_$checkbox[0].checked=true}};_GridView.prototype.BindCheckboxChangeListener=function(){var _this=this,_$grid=$("#"+_this.settings.id);_$grid.children("tbody").children("tr").each(function(){$(this).children("td").eq(0).children("input[type=checkbox]").bind("change",function(){var _$this=$(this),_id=_$this.parent().parent().attr("idx");if(typeof _this.settings.checkboxChangeHandle=="function"){_this.settings.checkboxChangeHandle({checked:_$this[0].checked,value:_id})}})});return _this};_GridView.prototype.Init=function(){return this.BindDataSource().BindColumnNo().SelectedColumn().AddEditColumn().BindColumnClickListener().DataPager().BindCheckboxChangeListener()};win.GridView=function(opts){var _gridView=new _GridView(opts).Init();return{GetSelectedValue:function(){return _gridView.GetSelectedValue()},SelectedCheckBox:function(columnIndex){_gridView.SelectedCheckBox(columnIndex)}}}})(window);